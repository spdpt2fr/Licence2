<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test R√âEL - Licence2 avec Supabase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .test-box {
      background: white;
      padding: 20px;
      margin: 15px 0;
      border-radius: 8px;
      border-left: 4px solid #ddd;
    }
    
    .test-success { border-color: #22c55e; }
    .test-error { border-color: #ef4444; }
    .test-warning { border-color: #f59e0b; }
    
    .status {
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .result {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
    
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    
    button:hover {
      background: #2563eb;
    }
    
    .error-text { color: #ef4444; }
    .success-text { color: #22c55e; }
    .warning-text { color: #f59e0b; }
  </style>
</head>
<body>
  <h1>üß™ Test R√âEL - Votre Supabase</h1>
  <p>Test avec votre projet Supabase r√©el : <code>qsbdzyhxppdbtsikhozp</code></p>

  <div class="test-box" id="connectionTest">
    <div class="status">1. Test de Connexion Supabase</div>
    <button onclick="testConnection()">Tester la Connexion</button>
    <div class="result" id="connectionResult">Pas encore test√©...</div>
  </div>

  <div class="test-box" id="tableTest">
    <div class="status">2. Test Existence Table 'licences'</div>
    <button onclick="testTable()">V√©rifier la Table</button>
    <div class="result" id="tableResult">Pas encore test√©...</div>
  </div>

  <div class="test-box" id="createTest">
    <div class="status">3. Test Cr√©ation Table (si n√©cessaire)</div>
    <button onclick="createTable()">Cr√©er la Table</button>
    <div class="result" id="createResult">Pas encore test√©...</div>
  </div>

  <div class="test-box" id="crudTest">
    <div class="status">4. Test CRUD Complet</div>
    <button onclick="testCRUD()">Tester CRUD</button>
    <div class="result" id="crudResult">Pas encore test√©...</div>
  </div>

  <div class="test-box" id="appTest">
    <div class="status">5. Test App Compl√®te</div>
    <button onclick="testApp()">Tester l'App</button>
    <div class="result" id="appResult">Pas encore test√©...</div>
  </div>

  <!-- Supabase CDN -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
    // Configuration R√âELLE de votre Supabase
    const SUPABASE_CONFIG = {
      url: 'https://qsbdzyhxppdbtsikhozp.supabase.co',
      anon_key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzYmR6eWh4cHBkYnRzaWtob3pwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU5OTgwOTAsImV4cCI6MjA1MTU3NDA5MH0.Vl7mXwrJxMqQBrVRMtfJixaXGD6qJtfFVZyTRm3ePfw'
    };

    let supabaseClient = null;

    // Initialiser Supabase
    function initSupabase() {
      try {
        const { createClient } = supabase;
        supabaseClient = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anon_key);
        return true;
      } catch (error) {
        console.error('Erreur init Supabase:', error);
        return false;
      }
    }

    // Test 1: Connexion Supabase
    async function testConnection() {
      const resultDiv = document.getElementById('connectionResult');
      const testBox = document.getElementById('connectionTest');
      
      try {
        resultDiv.textContent = 'Test en cours...';
        
        if (!initSupabase()) {
          throw new Error('Impossible d\'initialiser Supabase');
        }
        
        // Test de ping basique
        const { data, error } = await supabaseClient.from('_dummy_').select('*').limit(0);
        
        // Si on arrive ici, la connexion fonctionne (m√™me si la table n'existe pas)
        resultDiv.innerHTML = `<span class="success-text">‚úÖ CONNEXION R√âUSSIE</span>
URL: ${SUPABASE_CONFIG.url}
Statut: Client Supabase initialis√©
R√©ponse API: ${JSON.stringify({ connected: true }, null, 2)}`;
        
        testBox.classList.add('test-success');
        
      } catch (error) {
        resultDiv.innerHTML = `<span class="error-text">‚ùå √âCHEC CONNEXION</span>
Erreur: ${error.message}
URL: ${SUPABASE_CONFIG.url}
V√©rifiez: Dashboard Supabase accessible ?`;
        
        testBox.classList.add('test-error');
      }
    }

    // Test 2: V√©rifier si la table licences existe
    async function testTable() {
      const resultDiv = document.getElementById('tableResult');
      const testBox = document.getElementById('tableTest');
      
      try {
        if (!supabaseClient) {
          await testConnection();
        }
        
        resultDiv.textContent = 'V√©rification table licences...';
        
        const { data, error } = await supabaseClient
          .from('licences')
          .select('*')
          .limit(1);
        
        if (error) {
          if (error.code === '42P01') {
            // Table n'existe pas
            resultDiv.innerHTML = `<span class="warning-text">‚ö†Ô∏è TABLE N'EXISTE PAS</span>
Code erreur: ${error.code}
Message: ${error.message}
Action: Cr√©er la table avec le bouton ci-dessous`;
            testBox.classList.add('test-warning');
          } else {
            throw error;
          }
        } else {
          // Table existe
          resultDiv.innerHTML = `<span class="success-text">‚úÖ TABLE EXISTE</span>
Nom: licences
Lignes trouv√©es: ${data?.length || 0}
Statut: Pr√™te pour les tests CRUD`;
          testBox.classList.add('test-success');
        }
        
      } catch (error) {
        resultDiv.innerHTML = `<span class="error-text">‚ùå ERREUR TABLE</span>
Erreur: ${error.message}
Code: ${error.code || 'N/A'}`;
        testBox.classList.add('test-error');
      }
    }

    // Test 3: Cr√©er la table si n√©cessaire
    async function createTable() {
      const resultDiv = document.getElementById('createResult');
      const testBox = document.getElementById('createTest');
      
      try {
        resultDiv.textContent = 'Tentative de cr√©ation de la table...';
        
        // Note: La cr√©ation de table n√©cessite des permissions service_role
        // Ceci va probablement √©chouer avec anon_key
        const { data, error } = await supabaseClient.rpc('create_licences_table');
        
        if (error) {
          resultDiv.innerHTML = `<span class="warning-text">‚ö†Ô∏è CR√âATION IMPOSSIBLE</span>
Erreur: ${error.message}
Raison: Les permissions anon ne permettent pas CREATE TABLE
Solution: Cr√©er manuellement dans le Dashboard Supabase

SQL √† ex√©cuter dans l'√©diteur SQL:
CREATE TABLE licences (
  id TEXT PRIMARY KEY,
  software_name TEXT NOT NULL,
  vendor TEXT NOT NULL,
  version TEXT NOT NULL,
  type TEXT NOT NULL,
  seats INTEGER DEFAULT 1,
  purchase_date DATE NOT NULL,
  expiration_date DATE NOT NULL,
  initial_cost REAL DEFAULT 0,
  assigned_to TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

ALTER TABLE licences ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public access" ON licences FOR ALL USING (true);`;
          testBox.classList.add('test-warning');
        } else {
          resultDiv.innerHTML = `<span class="success-text">‚úÖ TABLE CR√â√âE</span>`;
          testBox.classList.add('test-success');
        }
        
      } catch (error) {
        resultDiv.innerHTML = `<span class="warning-text">‚ö†Ô∏è CR√âATION MANUELLE REQUISE</span>
Allez dans votre Dashboard Supabase > √âditeur SQL
Copiez-collez le SQL ci-dessus`;
        testBox.classList.add('test-warning');
      }
    }

    // Test 4: CRUD complet
    async function testCRUD() {
      const resultDiv = document.getElementById('crudResult');
      const testBox = document.getElementById('crudTest');
      
      try {
        if (!supabaseClient) {
          await testConnection();
        }
        
        resultDiv.textContent = 'Test CRUD en cours...';
        
        // CREATE
        const testLicence = {
          id: 'test-' + Date.now(),
          software_name: 'Test Software',
          vendor: 'Test Vendor',
          version: '1.0',
          type: 'perpetuelle',
          seats: 1,
          purchase_date: '2025-01-01',
          expiration_date: '2025-12-31',
          initial_cost: 100,
          assigned_to: 'Test User'
        };
        
        const { data: createData, error: createError } = await supabaseClient
          .from('licences')
          .insert([testLicence])
          .select();
        
        if (createError) throw createError;
        
        // READ
        const { data: readData, error: readError } = await supabaseClient
          .from('licences')
          .select('*')
          .eq('id', testLicence.id);
        
        if (readError) throw readError;
        
        // UPDATE
        const { data: updateData, error: updateError } = await supabaseClient
          .from('licences')
          .update({ version: '2.0' })
          .eq('id', testLicence.id)
          .select();
        
        if (updateError) throw updateError;
        
        // DELETE
        const { data: deleteData, error: deleteError } = await supabaseClient
          .from('licences')
          .delete()
          .eq('id', testLicence.id);
        
        if (deleteError) throw deleteError;
        
        resultDiv.innerHTML = `<span class="success-text">‚úÖ CRUD COMPLET R√âUSSI</span>
CREATE: ‚úÖ Licence cr√©√©e
READ: ‚úÖ Licence lue (${readData.length} r√©sultat)
UPDATE: ‚úÖ Version mise √† jour (1.0 ‚Üí 2.0)
DELETE: ‚úÖ Licence supprim√©e

üéâ Votre base Supabase fonctionne parfaitement !`;
        
        testBox.classList.add('test-success');
        
      } catch (error) {
        resultDiv.innerHTML = `<span class="error-text">‚ùå √âCHEC CRUD</span>
Erreur: ${error.message}
Code: ${error.code || 'N/A'}

V√©rifiez:
- Table 'licences' cr√©√©e ?
- Politiques RLS configur√©es ?
- Permissions correctes ?`;
        
        testBox.classList.add('test-error');
      }
    }

    // Test 5: Application compl√®te
    async function testApp() {
      const resultDiv = document.getElementById('appResult');
      const testBox = document.getElementById('appTest');
      
      try {
        resultDiv.textContent = 'Test application compl√®te...';
        
        // Test si tous les fichiers sont accessibles
        const moduleTests = {
          config: typeof SUPABASE_CONFIG !== 'undefined',
          supabase: typeof supabase !== 'undefined',
          api: false, // On va tester √ßa
          app: false  // On va tester √ßa
        };
        
        // Test simple: peut-on cr√©er une licence et la r√©cup√©rer ?
        const testId = 'app-test-' + Date.now();
        
        const { error: insertError } = await supabaseClient
          .from('licences')
          .insert([{
            id: testId,
            software_name: 'App Test',
            vendor: 'Test',
            version: '1.0',
            type: 'perpetuelle',
            seats: 1,
            purchase_date: '2025-01-01',
            expiration_date: '2025-12-31',
            initial_cost: 0
          }]);
        
        const { data, error: selectError } = await supabaseClient
          .from('licences')
          .select('*');
        
        // Nettoyer
        await supabaseClient
          .from('licences')
          .delete()
          .eq('id', testId);
        
        if (insertError || selectError) {
          throw new Error(insertError?.message || selectError?.message);
        }
        
        resultDiv.innerHTML = `<span class="success-text">‚úÖ APPLICATION PR√äTE</span>
Configuration: ‚úÖ Supabase configur√©
Connexion: ‚úÖ Base accessible
CRUD: ‚úÖ Op√©rations fonctionnelles
Donn√©es: ${data.length} licence(s) dans la base

üöÄ Votre application Licence2 peut maintenant utiliser:
- index-new.html (interface moderne)
- Mode en ligne avec votre Supabase
- Sauvegarde persistante des donn√©es

Testez maintenant: index-new.html`;
        
        testBox.classList.add('test-success');
        
      } catch (error) {
        resultDiv.innerHTML = `<span class="error-text">‚ùå APPLICATION NON PR√äTE</span>
Erreur: ${error.message}

√âtapes √† compl√©ter:
1. Cr√©er la table 'licences' dans Supabase
2. Configurer les politiques RLS
3. Tester les permissions`;
        
        testBox.classList.add('test-error');
      }
    }

    // Auto-test au chargement
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üß™ Tests Supabase charg√©s');
      console.log('Config:', SUPABASE_CONFIG);
    });
  </script>

  <div style="margin-top: 40px; padding: 20px; background: #e0f2fe; border-radius: 8px;">
    <h3>üéØ Prochaines √âtapes</h3>
    <p><strong>Si tous les tests passent :</strong></p>
    <ul>
      <li>‚úÖ Votre Supabase fonctionne</li>
      <li>‚úÖ L'application peut sauvegarder</li>
      <li>‚úÖ Plus besoin de backend Express</li>
    </ul>
    
    <p><strong>Liens utiles :</strong></p>
    <ul>
      <li><a href="https://qsbdzyhxppdbtsikhozp.supabase.co" target="_blank">üîó Votre Dashboard Supabase</a></li>
      <li><a href="index-new.html">üöÄ Nouvelle Application</a></li>
    </ul>
  </div>
</body>
</html>
