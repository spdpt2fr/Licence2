<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestionnaire de Licences - Version Frontend Pur</title>
    <link rel="stylesheet" href="style.css" />

    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Configuration et modules -->
    <script src="config.js"></script>
    <script src="api.js"></script>
    <script src="auth.js"></script>
    <script src="app.js"></script>
  </head>
  <body>
    <div id="loginPage" class="login-page hidden">
      <form id="loginForm" class="login-form">
        <h2>Connexion</h2>
        <input id="loginUser" type="text" placeholder="Login" required />
        <input
          id="loginPass"
          type="password"
          placeholder="Mot de passe"
          required
        />
        <button type="submit" class="btn btn-primary">Se connecter</button>
        <p class="login-hint">Identifiants par d√©faut&nbsp;: <b>Admin/Admin</b></p>
      </form>
    </div>

    <div id="passwordPage" class="login-page hidden">
      <form id="passwordForm" class="login-form">
        <h2>Nouveau mot de passe</h2>
        <input
          id="newPass"
          type="password"
          placeholder="Mot de passe"
          required
        />
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </form>
    </div>

    <div class="container">
      <!-- Header avec statut de connexion -->
      <header>
        <h1>üñ•Ô∏è Gestionnaire de Licences</h1>
        <div id="appStatus" class="status-bar">
          <span class="status-indicator offline"></span>
          Initialisation...
        </div>
        <div class="user-info">
          <span id="currentUserDisplay" class="current-user hidden"></span>
          <button id="logoutBtn" class="btn btn-secondary hidden">
            Se d√©connecter
          </button>
        </div>
      </header>

      <!-- Alertes d'expiration -->
      <section id="alerts" class="alerts"></section>

      <!-- Barre d'outils -->
      <div class="toolbar">
        <button id="newLicence" class="btn btn-primary">
          ‚ûï Ajouter une licence
        </button>
        <button id="newUser" class="btn btn-secondary hidden">
          üë§ Nouvel utilisateur
        </button>
        <div class="search-container">
          <input
            type="text"
            id="search"
            placeholder="üîç Rechercher par nom ou √©diteur..."
          />
          <span id="licencesCount" class="count">0 licence(s)</span>
        </div>
        <button id="exportCsv" class="btn btn-secondary">üì§ Export CSV</button>
        <button id="importCsv" class="btn btn-secondary">üì• Import CSV</button>
        <input type="file" id="importFile" accept=".csv" class="hidden" />
      </div>

      <!-- Tableau des licences -->
      <div class="table-container">
        <table id="licenceTable">
          <thead>
            <tr>
              <th>Logiciel</th>
              <th>√âditeur</th>
              <th>Version</th>
              <th>Type</th>
              <th>Si√®ges</th>
              <th>Expiration</th>
              <th>Co√ªt</th>
              <th>Assign√© √†</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Les donn√©es seront charg√©es dynamiquement -->
          </tbody>
        </table>
      </div>

      <!-- Formulaire modal -->
      <div id="licenceForm" class="modal hidden">
        <div class="modal-content">
          <form>
            <h2 id="formTitle">Nouvelle licence</h2>

            <input type="hidden" id="licenceId" />

            <div class="form-grid">
              <div class="form-group">
                <label for="softwareName">Nom du logiciel *</label>
                <input
                  type="text"
                  id="softwareName"
                  required
                  placeholder="Ex: Microsoft Office"
                />
              </div>

              <div class="form-group">
                <label for="vendor">√âditeur *</label>
                <input
                  type="text"
                  id="vendor"
                  required
                  placeholder="Ex: Microsoft"
                />
              </div>

              <div class="form-group">
                <label for="version">Version *</label>
                <input
                  type="text"
                  id="version"
                  required
                  placeholder="Ex: 2024"
                />
              </div>

              <div class="form-group">
                <label for="type">Type de licence</label>
                <select id="type">
                  <option value="perpetuelle">Perp√©tuelle</option>
                  <option value="abonnement">Abonnement</option>
                  <option value="utilisateur">Par utilisateur</option>
                  <option value="concurrent">Concurrent</option>
                </select>
              </div>

              <div class="form-group">
                <label for="seats">Nombre de si√®ges</label>
                <input type="number" id="seats" min="1" value="1" required />
              </div>

              <div class="form-group">
                <label for="purchaseDate">Date d'achat</label>
                <input type="date" id="purchaseDate" required />
              </div>

              <div class="form-group">
                <label for="expirationDate">Date d'expiration</label>
                <input type="date" id="expirationDate" required />
              </div>

              <div class="form-group">
                <label for="initialCost">Co√ªt initial (‚Ç¨)</label>
                <input
                  type="number"
                  id="initialCost"
                  min="0"
                  step="0.01"
                  required
                  placeholder="0.00"
                />
              </div>

              <div class="form-group full-width">
                <label for="assignedTo">Assign√© √† (employ√©/d√©partement)</label>
                <input
                  type="text"
                  id="assignedTo"
                  placeholder="Ex: Service Marketing"
                />
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                üíæ Enregistrer
              </button>
              <button type="button" id="cancelForm" class="btn btn-secondary">
                ‚ùå Annuler
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal ajout utilisateur -->
      <div id="userForm" class="modal hidden">
        <div class="modal-content">
          <form>
            <h2>Nouvel utilisateur</h2>
            <div class="form-group">
              <label for="userLogin">Login</label>
              <input id="userLogin" type="text" required />
            </div>
            <div class="form-group">
              <label for="userPassword">Mot de passe</label>
              <input id="userPassword" type="password" required />
            </div>
            <div class="form-group">
              <label for="userRole">R√¥le</label>
              <select id="userRole">
                <option value="read">Lecture</option>
                <option value="write">√âcriture</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Ajouter</button>
              <button
                type="button"
                id="cancelUserForm"
                class="btn btn-secondary"
              >
                Annuler
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Overlay pour le modal -->
      <div class="modal-overlay hidden" onclick="closeModals()"></div>
    </div>

    <script>
      // Attendre que tous les scripts soient charg√©s
      window.addEventListener('load', async () => {
        console.log('üîÑ Initialisation de l\'application...');
        
        try {
          // V√©rifier que Auth est disponible
          if (!window.Auth) {
            throw new Error('Module Auth non disponible');
          }

          // Initialiser Auth
          if (typeof window.Auth.init === 'function') {
            await window.Auth.init();
            console.log('‚úÖ Auth initialis√© avec succ√®s');
          } else {
            throw new Error('Auth.init n\'est pas une fonction');
          }

          // Debug - v√©rifier l'objet Auth apr√®s initialisation
          console.log('üîç Debug Auth apr√®s init:', {
            hasPermission: typeof window.Auth.hasPermission,
            getRoleDisplayName: typeof window.Auth.getRoleDisplayName,
            currentUser: window.Auth.currentUser,
            methods: Object.getOwnPropertyNames(window.Auth).filter(prop => typeof window.Auth[prop] === 'function')
          });

        } catch (err) {
          console.error('‚ùå Erreur init Auth:', err);
          alert('Erreur d\'initialisation: ' + err.message);
          return;
        }

        const loginPage = document.getElementById("loginPage");
        const passwordPage = document.getElementById("passwordPage");
        const container = document.querySelector(".container");
        const logoutBtn = document.getElementById("logoutBtn");
        const currentUserDisplay = document.getElementById("currentUserDisplay");
        const newUserBtn = document.getElementById("newUser");

        // Fonction pour mettre √† jour l'affichage des permissions
        function updateUIPermissions() {
          console.log('üîß updateUIPermissions appel√©e');
          
          if (!window.Auth || !window.Auth.currentUser) {
            console.log('‚ùå Pas d\'utilisateur connect√©');
            return;
          }

          // V√©rification robuste des m√©thodes
          if (typeof window.Auth.hasPermission !== 'function') {
            console.error('‚ùå window.Auth.hasPermission n\'est pas une fonction');
            console.log('window.Auth disponible:', Object.getOwnPropertyNames(window.Auth));
            return;
          }

          if (typeof window.Auth.getRoleDisplayName !== 'function') {
            console.error('‚ùå window.Auth.getRoleDisplayName n\'est pas une fonction');
            // Fallback pour le nom du r√¥le
            const roleMap = {
              'read': 'Lecture',
              'write': '√âcriture', 
              'admin': 'Admin'
            };
            const roleDisplayName = roleMap[window.Auth.currentUser.role] || 'Utilisateur';
            currentUserDisplay.textContent = `${window.Auth.currentUser.login} (${roleDisplayName})`;
          } else {
            // Utiliser la m√©thode si elle existe
            const roleDisplayName = window.Auth.getRoleDisplayName();
            currentUserDisplay.textContent = `${window.Auth.currentUser.login} (${roleDisplayName})`;
          }
          
          currentUserDisplay.classList.remove("hidden");
          
          // Afficher/masquer le bouton "Nouvel utilisateur" selon les permissions
          try {
            if (window.Auth.hasPermission('create_user')) {
              newUserBtn.classList.remove("hidden");
            } else {
              newUserBtn.classList.add("hidden");
            }
          } catch (err) {
            console.error('‚ùå Erreur v√©rification permission create_user:', err);
            newUserBtn.classList.add("hidden"); // Par s√©curit√©, masquer le bouton
          }
        }

        async function showApp() {
          loginPage.classList.add("hidden");
          passwordPage.classList.add("hidden");
          container.style.display = "block";
          logoutBtn.classList.remove("hidden");
          updateUIPermissions();
          await startLicenceApp();
        }

        window.closeModals = function () {
          if (window.app) app.closeForm();
          document.getElementById("userForm").classList.add("hidden");
        };

        // V√©rifier l'√©tat de connexion
        if (window.Auth.currentUser) {
          if (window.Auth.currentUser.must_change) {
            passwordPage.classList.remove("hidden");
          } else {
            showApp();
          }
        } else {
          loginPage.classList.remove("hidden");
          container.style.display = "none";
          logoutBtn.classList.add("hidden");
          currentUserDisplay.classList.add("hidden");
        }

        // Gestionnaire de connexion
        document
          .getElementById("loginForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            try {
              const user = document.getElementById("loginUser").value.trim();
              const pass = document.getElementById("loginPass").value;
              
              // V√©rifier que Auth.login existe
              if (typeof window.Auth.login !== 'function') {
                throw new Error('Auth.login n\'est pas disponible');
              }
              
              await window.Auth.login(user, pass);
              
              if (window.Auth.currentUser.must_change) {
                loginPage.classList.add("hidden");
                passwordPage.classList.remove("hidden");
              } else {
                showApp();
              }
            } catch (err) {
              console.error('Erreur de connexion:', err);
              alert(err.message || 'Erreur de connexion');
            }
          });

        // Gestionnaire de changement de mot de passe
        document
          .getElementById("passwordForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            try {
              const newPass = document.getElementById("newPass").value;
              await window.Auth.changePassword(newPass);
              showApp();
            } catch (err) {
              console.error('Erreur changement mot de passe:', err);
              alert('Erreur: ' + err.message);
            }
          });

        // Gestionnaire bouton "Nouvel utilisateur" avec v√©rification des permissions
        document.getElementById("newUser").addEventListener("click", () => {
          if (typeof window.Auth.hasPermission === 'function' && window.Auth.hasPermission('create_user')) {
            document.getElementById("userForm").classList.remove("hidden");
          } else {
            alert("Vous n'avez pas les permissions pour cr√©er des utilisateurs.");
          }
        });

        document
          .getElementById("cancelUserForm")
          .addEventListener("click", () => {
            document.getElementById("userForm").classList.add("hidden");
          });

        logoutBtn.addEventListener("click", () => {
          window.Auth.logout();
          location.reload();
        });

        // Gestionnaire de cr√©ation d'utilisateur avec v√©rification des permissions
        document
          .getElementById("userForm")
          .querySelector("form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            
            // V√©rifier les permissions avant de cr√©er
            if (typeof window.Auth.hasPermission !== 'function' || !window.Auth.hasPermission('create_user')) {
              alert("Vous n'avez pas les permissions pour cr√©er des utilisateurs.");
              return;
            }
            
            try {
              const l = document.getElementById("userLogin").value.trim();
              const p = document.getElementById("userPassword").value;
              const r = document.getElementById("userRole").value;
              await window.Auth.api.createUser(l, p, r);
              document.getElementById("userForm").classList.add("hidden");
              // Reset du formulaire
              document.getElementById("userLogin").value = "";
              document.getElementById("userPassword").value = "";
              document.getElementById("userRole").value = "read";
              alert("Utilisateur ajout√© avec succ√®s !");
            } catch (err) {
              alert("Erreur: " + err.message);
            }
          });
      });
    </script>
  </body>
</html>