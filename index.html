<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestionnaire de Licences - CORRIG√â</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <!-- Page de connexion -->
    <div id="loginPage" class="login-page">
      <form id="loginForm" class="login-form">
        <h2>Connexion - Version Corrig√©e</h2>
        <input id="loginUser" type="text" placeholder="Login" required />
        <input id="loginPass" type="password" placeholder="Mot de passe" required />
        <button type="submit" class="btn btn-primary">Se connecter</button>
        <p class="login-hint">Identifiants par d√©faut: <b>Admin/Admin</b></p>
      </form>
    </div>

    <!-- Application principale -->
    <div id="mainApp" class="container hidden">
      <!-- Header -->
      <div class="app-header">
        <h1>Gestionnaire de Licences</h1>
        <div class="header-user">
          <div class="status-bar">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText">Chargement...</span>
          </div>
          <div class="current-user" id="currentUser">Utilisateur</div>
          <button id="logoutBtn" class="btn btn-secondary">D√©connexion</button>
        </div>
      </div>

      <!-- Alertes -->
      <div id="alertsContainer"></div>

      <!-- Actions du tableau -->
      <div class="table-container">
        <div class="table-header">
          <div class="table-actions">
            <div class="search-container">
              <input type="text" id="searchInput" placeholder="Rechercher une licence..." />
              <div class="count" id="licenceCount">0 licence(s)</div>
            </div>
            <button id="addLicenceBtn" class="btn btn-primary">
              ‚ûï Nouvelle licence
            </button>
            <button id="refreshBtn" class="btn btn-secondary">
              üîÑ Actualiser
            </button>
          </div>
        </div>

        <!-- Tableau des licences -->
        <table class="licence-table">
          <thead>
            <tr>
              <th onclick="sortTable('id')">ID</th>
              <th onclick="sortTable('software_name')">Logiciel</th>
              <th onclick="sortTable('vendor')">Fournisseur</th>
              <th onclick="sortTable('version')">Version</th>
              <th onclick="sortTable('type')">Type</th>
              <th onclick="sortTable('expiration_date')">Expiration</th>
              <th onclick="sortTable('initial_cost')">Prix</th>
              <th onclick="sortTable('seats')">Postes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="licenceTableBody">
            <!-- Les licences seront inject√©es ici -->
          </tbody>
        </table>
      </div>
    </div>

    <script>
      // Configuration Supabase - API KEY CORRIG√âE
      const SUPABASE_URL = 'https://qsbdzyhxppdbtsikhozp.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzYmR6eWh4cHBkYnRzaWtob3pwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0NzI5OTYsImV4cCI6MjA2NzA0ODk5Nn0.kanu7GfIr-qDtd3wcSmDbjEMK9VYX4o9HdG4cD0rcus';
      
      let supabase, currentUser = null, licences = [], sortDirection = {};

      // Initialisation
      document.addEventListener('DOMContentLoaded', async () => {
        console.log('üöÄ Initialisation avec MAPPING CORRIG√â...');
        try {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
          console.log('‚úÖ Supabase initialis√©');
          
          // Test de connexion obligatoire
          await testDatabaseConnection();
          
          const sessionData = getStoredSession();
          if (sessionData) {
            currentUser = sessionData;
            showApp();
            await loadLicences();
          }
        } catch (error) {
          console.error('‚ùå Erreur:', error);
          showNotification('Erreur de connexion √† la base de donn√©es', 'danger');
        }
      });

      // Test de connexion base de donn√©es
      async function testDatabaseConnection() {
        try {
          console.log('üîó Test de connexion √† la base de donn√©es...');
          const { data, error, count } = await supabase
            .from('licences')
            .select('*', { count: 'exact' });
          
          if (error) {
            console.error('‚ùå Erreur connexion base:', error);
            throw new Error(`Erreur base de donn√©es: ${error.message}`);
          }
          
          console.log(`‚úÖ Connexion base r√©ussie - ${count} licences trouv√©es`);
          console.log('üìä Structure des donn√©es:', data[0] ? Object.keys(data[0]) : 'Aucune donn√©e');
          return { success: true, count };
          
        } catch (error) {
          console.error('‚ùå Test connexion √©chou√©:', error);
          throw error;
        }
      }

      // Connexion
      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('loginUser').value.trim().toLowerCase();
        const password = document.getElementById('loginPass').value;
        
        if (username === 'admin' && password === 'admin') {
          currentUser = { login: 'admin', role: 'admin', nom: 'Administrateur' };
          storeSession(currentUser);
          showApp();
          await loadLicences();
          showNotification('Connexion r√©ussie !', 'success');
        } else {
          showNotification('Identifiants incorrects', 'danger');
        }
      });

      function showApp() {
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('currentUser').textContent = `${currentUser.nom} (${currentUser.role})`;
        setupEventListeners();
      }

      function setupEventListeners() {
        document.getElementById('logoutBtn').addEventListener('click', () => {
          if (confirm('D√©connexion ?')) logout();
        });
        document.getElementById('searchInput').addEventListener('input', (e) => {
          filterLicences(e.target.value);
        });
        document.getElementById('addLicenceBtn').addEventListener('click', () => {
          showNotification('Fonctionnalit√© en d√©veloppement', 'info');
        });
        document.getElementById('refreshBtn').addEventListener('click', async () => {
          await loadLicences();
          showNotification('Donn√©es actualis√©es', 'success');
        });
      }

      async function loadLicences() {
        try {
          updateStatus('Chargement depuis la base...', false);
          console.log('üîÑ Chargement des licences depuis Supabase...');
          
          const { data, error } = await supabase
            .from('licences')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) {
            console.error('‚ùå Erreur Supabase:', error);
            throw new Error(`Erreur base de donn√©es: ${error.message}`);
          }
          
          licences = data || [];
          updateStatus(`Base de donn√©es connect√©e (${licences.length} licences)`, true);
          
          console.log(`‚úÖ ${licences.length} licences charg√©es depuis la base`);
          if (licences.length > 0) {
            console.log('üìã Premi√®re licence avec mapping corrig√©:', {
              id: licences[0].id,
              logiciel: licences[0].software_name,
              fournisseur: licences[0].vendor,
              version: licences[0].version,
              type: licences[0].type,
              expiration: licences[0].expiration_date,
              prix: licences[0].initial_cost,
              postes: licences[0].seats
            });
          }
          
          renderLicences();
          updateLicenceCount();
          checkExpirations();
          
        } catch (error) {
          console.error('‚ùå Erreur chargement:', error);
          updateStatus('Erreur base de donn√©es', false);
          showNotification(`Erreur: ${error.message}`, 'danger');
          
          licences = [];
          renderLicences();
          updateLicenceCount();
        }
      }

      function renderLicences() {
        const tbody = document.getElementById('licenceTableBody');
        tbody.innerHTML = '';
        
        if (licences.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = '<td colspan="9" style="text-align: center; color: #666; padding: 20px;">Aucune licence trouv√©e dans la base de donn√©es</td>';
          tbody.appendChild(row);
          return;
        }
        
        licences.forEach(licence => {
          tbody.appendChild(createLicenceRow(licence));
        });
      }

      function createLicenceRow(licence) {
        const row = document.createElement('tr');
        const today = new Date();
        const expiration = new Date(licence.expiration_date);
        const daysUntilExpiration = Math.ceil((expiration - today) / (1000 * 60 * 60 * 24));
        
        let statusClass = '', statusText = 'Active';
        if (daysUntilExpiration < 0) {
          statusClass = 'status-expired';
          statusText = 'Expir√©e';
        } else if (daysUntilExpiration <= 30) {
          statusClass = 'status-warning';
          statusText = 'Expire bient√¥t';
        }
        
        row.className = statusClass;
        row.innerHTML = `
          <td>#${licence.id}</td>
          <td>${licence.software_name || 'N/A'}</td>
          <td>${licence.vendor || 'N/A'}</td>
          <td>${licence.version || 'N/A'}</td>
          <td><span class="badge">${licence.type || 'N/A'}</span></td>
          <td>${formatDate(licence.expiration_date)}</td>
          <td>${formatPrice(licence.initial_cost)}</td>
          <td>${licence.seats || 0} poste(s)</td>
          <td>
            <button class="btn-view" onclick="viewLicence(${licence.id})">üëÅÔ∏è</button>
            <button class="btn-edit" onclick="editLicence(${licence.id})">‚úèÔ∏è</button>
            <button class="btn-delete" onclick="deleteLicence(${licence.id})">üóëÔ∏è</button>
          </td>
        `;
        return row;
      }

      function checkExpirations() {
        const today = new Date();
        let expiredCount = 0, warningCount = 0;
        
        licences.forEach(licence => {
          const expiration = new Date(licence.expiration_date);
          const daysUntilExpiration = Math.ceil((expiration - today) / (1000 * 60 * 60 * 24));
          
          if (daysUntilExpiration < 0) expiredCount++;
          else if (daysUntilExpiration <= 30) warningCount++;
        });
        
        const alertsContainer = document.getElementById('alertsContainer');
        alertsContainer.innerHTML = '';
        
        if (expiredCount > 0) showAlert(`‚ö†Ô∏è ${expiredCount} licence(s) expir√©e(s)`, 'danger');
        if (warningCount > 0) showAlert(`‚ö° ${warningCount} licence(s) expire(nt) bient√¥t`, 'warning');
      }

      function showAlert(message, type) {
        const alertsContainer = document.getElementById('alertsContainer');
        const alert = document.createElement('div');
        alert.className = `alert ${type}`;
        alert.innerHTML = `<span>${message}</span><button onclick="this.parentElement.remove()">‚úï</button>`;
        alertsContainer.appendChild(alert);
      }

      function formatDate(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleDateString('fr-FR');
      }

      function formatPrice(price) {
        if (!price && price !== 0) return 'N/A';
        return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(price);
      }

      function updateStatus(text, online) {
        document.getElementById('statusText').textContent = text;
        document.getElementById('statusIndicator').className = `status-indicator ${online ? 'online' : 'offline'}`;
      }

      function updateLicenceCount() {
        document.getElementById('licenceCount').textContent = `${licences.length} licence(s)`;
      }

      function filterLicences(searchTerm) {
        const rows = document.querySelectorAll('#licenceTableBody tr');
        const term = searchTerm.toLowerCase();
        rows.forEach(row => {
          row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
        });
      }

      function viewLicence(id) {
        const licence = licences.find(l => l.id === id);
        if (licence) {
          alert(`Licence: ${licence.software_name} ${licence.version}\\nFournisseur: ${licence.vendor}\\nType: ${licence.type}\\nExpiration: ${formatDate(licence.expiration_date)}\\nPrix: ${formatPrice(licence.initial_cost)}\\nPostes: ${licence.seats}`);
        }
      }

      function editLicence(id) { showNotification('√âdition en d√©veloppement', 'info'); }
      function deleteLicence(id) { if (confirm('Supprimer ?')) showNotification('Suppression en d√©veloppement', 'info'); }

      function sortTable(column) {
        const direction = sortDirection[column] === 'asc' ? 'desc' : 'asc';
        sortDirection[column] = direction;
        
        licences.sort((a, b) => {
          let aVal = a[column] || '', bVal = b[column] || '';
          if (column === 'initial_cost' || column === 'seats') { 
            aVal = parseFloat(aVal) || 0; 
            bVal = parseFloat(bVal) || 0; 
          } else if (column === 'expiration_date') { 
            aVal = new Date(aVal); 
            bVal = new Date(bVal); 
          } else { 
            aVal = aVal.toString().toLowerCase(); 
            bVal = bVal.toString().toLowerCase(); 
          }
          return direction === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
        });
        renderLicences();
      }

      function storeSession(userInfo) {
        try {
          document.cookie = `session_user=${btoa(JSON.stringify(userInfo))}; max-age=86400; path=/`;
        } catch (error) { console.warn('Session storage failed'); }
      }

      function getStoredSession() {
        try {
          const cookies = document.cookie.split(';');
          const sessionCookie = cookies.find(c => c.trim().startsWith('session_user='));
          if (sessionCookie) {
            return JSON.parse(atob(sessionCookie.split('=')[1]));
          }
        } catch (error) { console.warn('Session invalid'); }
        return null;
      }

      function logout() {
        document.cookie = 'session_user=; max-age=0; path=/';
        currentUser = null;
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('loginForm').reset();
        showNotification('D√©connexion r√©ussie', 'info');
      }

      function showNotification(message, type = 'info') {
        const container = document.getElementById('notificationsContainer') || createNotificationsContainer();
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `<div class="toast-content"><span>${message}</span><button class="toast-close" onclick="this.parentElement.parentElement.remove()">‚úï</button></div>`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => { toast.classList.add('removing'); setTimeout(() => toast.remove(), 300); }, 5000);
      }

      function createNotificationsContainer() {
        const container = document.createElement('div');
        container.id = 'notificationsContainer';
        container.className = 'notifications-container';
        document.body.appendChild(container);
        return container;
      }
    </script>
  </body>
</html>