<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestionnaire de Licences - CRUD COMPLET</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
      /* Styles pour le menu administration */
      .admin-menu {
        display: none;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .admin-menu.visible {
        display: flex;
      }
      
      .admin-menu-title {
        color: white;
        font-weight: bold;
        margin: 0;
        font-size: 1rem;
      }
      
      .admin-menu-buttons {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      
      .admin-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 0.5rem 1rem;
        border-radius: 5px;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .admin-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
      }
      
      @media (max-width: 768px) {
        .admin-menu {
          flex-direction: column;
          gap: 0.75rem;
          text-align: center;
        }
        
        .admin-menu-buttons {
          justify-content: center;
        }
        
        .admin-btn {
          font-size: 0.8rem;
          padding: 0.4rem 0.8rem;
        }
        
        .admin-btn span.text {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <!-- Page de connexion -->
    <div id="loginPage" class="login-page">
      <form id="loginForm" class="login-form">
        <h2>Connexion - CRUD Complet</h2>
        <input id="loginUser" type="text" placeholder="Login" required />
        <input id="loginPass" type="password" placeholder="Mot de passe" required />
        <button type="submit" class="btn btn-primary">Se connecter</button>
        <p class="login-hint">Identifiants par d√©faut: <b>Admin/Admin</b></p>
      </form>
    </div>

    <!-- Application principale -->
    <div id="mainApp" class="container hidden">
      <!-- Header --></div>
      <div class="app-header">
        <h1>Gestionnaire de Licences</h1>
        <div class="header-user">
          <div class="status-bar">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText">Chargement...</span>
          </div>
          <div class="current-user" id="currentUser">Utilisateur</div>
          <button id="logoutBtn" class="btn btn-secondary">D√©connexion</button>
        </div>
      </div>

      <!-- Menu Administration (visible uniquement pour les admins) -->
      <div id="adminMenu" class="admin-menu">
        <h3 class="admin-menu-title">üõ†Ô∏è Administration</h3>
        <div class="admin-menu-buttons">
          <a href="users-management.html" class="admin-btn">
            üë• <span class="text">Utilisateurs</span>
          </a>
          <button class="admin-btn" onclick="showComingSoon()">
            ‚öôÔ∏è <span class="text">Param√®tres</span>
          </button>
        </div>
      </div>

      <!-- Alertes -->
      <div id="alertsContainer"></div>

      <!-- Actions du tableau -->
      <div class="table-container">
        <div class="table-header">
          <div class="table-actions">
            <div class="search-container">
              <input type="text" id="searchInput" placeholder="Rechercher une licence..." />
              <div class="count" id="licenceCount">0 licence(s)</div>
            </div>
            <button id="addLicenceBtn" class="btn btn-primary">
              ‚ûï Nouvelle licence
            </button>
            <button id="refreshBtn" class="btn btn-secondary">
              üîÑ Actualiser
            </button>
          </div>
        </div>

        <!-- Tableau des licences -->
        <table class="licence-table">
          <thead>
            <tr>
              <th onclick="sortTable('id')">ID</th>
              <th onclick="sortTable('software_name')">Logiciel</th>
              <th onclick="sortTable('vendor')">Fournisseur</th>
              <th onclick="sortTable('version')">Version</th>
              <th onclick="sortTable('type')">Type</th>
              <th onclick="sortTable('expiration_date')">Expiration</th>
              <th onclick="sortTable('initial_cost')">Prix</th>
              <th onclick="sortTable('seats')">Postes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="licenceTableBody">
            <!-- Les licences seront inject√©es ici -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal pour ajouter/√©diter une licence -->
    <div id="licenceModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">Nouvelle licence</h3>
          <button id="closeModalBtn" class="close-btn">‚úï</button>
        </div>
        <form id="licenceForm" class="modal-body">
          <div class="form-group">
            <label for="software_name">Nom du logiciel *</label>
            <input type="text" id="software_name" name="software_name" required />
          </div>
          
          <div class="form-group">
            <label for="vendor">Fournisseur *</label>
            <input type="text" id="vendor" name="vendor" required />
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="version">Version</label>
              <input type="text" id="version" name="version" />
            </div>
            
            <div class="form-group">
              <label for="type">Type *</label>
              <select id="type" name="type" required>
                <option value="">S√©lectionner...</option>
                <option value="perpetuelle">Perp√©tuelle</option>
                <option value="subscription">Abonnement</option>
                <option value="trial">Essai</option>
                <option value="educational">√âducation</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="purchase_date">Date d'achat</label>
              <input type="date" id="purchase_date" name="purchase_date" />
            </div>
            
            <div class="form-group">
              <label for="expiration_date">Date d'expiration</label>
              <input type="date" id="expiration_date" name="expiration_date" />
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="initial_cost">Prix (‚Ç¨)</label>
              <input type="number" id="initial_cost" name="initial_cost" step="0.01" min="0" />
            </div>
            
            <div class="form-group">
              <label for="seats">Nombre de postes</label>
              <input type="number" id="seats" name="seats" min="1" value="1" />
            </div>
          </div>
          
          <div class="form-group">
            <label for="assigned_to">Assign√© √†</label>
            <input type="text" id="assigned_to" name="assigned_to" placeholder="Nom d'utilisateur ou √©quipe" />
          </div>
          
          <div class="modal-footer">
            <button type="button" id="cancelBtn" class="btn btn-secondary">Annuler</button>
            <button type="submit" id="saveBtn" class="btn btn-primary">
              <span id="saveText">Cr√©er</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Configuration Supabase
      const SUPABASE_URL = 'https://qsbdzyhxppdbtsikhozp.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzYmR6eWh4cHBkYnRzaWtob3pwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0NzI5OTYsImV4cCI6MjA2NzA0ODk5Nn0.kanu7GfIr-qDtd3wcSmDbjEMK9VYX4o9HdG4cD0rcus';
      
      let supabase, currentUser = null, licences = [], sortDirection = {};
      let editingLicenceId = null;

      // Initialisation
      document.addEventListener('DOMContentLoaded', async () => {
        console.log('üöÄ Initialisation avec CRUD COMPLET...');
        try {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
          console.log('‚úÖ Supabase initialis√©');
          
          await testDatabaseConnection();
          
          const sessionData = getStoredSession();
          if (sessionData) {
            currentUser = sessionData;
            showApp();
            await loadLicences();
          }
        } catch (error) {
          console.error('‚ùå Erreur:', error);
          showNotification('Erreur de connexion √† la base de donn√©es', 'danger');
        }
      });

      async function testDatabaseConnection() {
        try {
          console.log('üîó Test de connexion √† la base de donn√©es...');
          const { data, error, count } = await supabase
            .from('licences')
            .select('*', { count: 'exact' });
          
          if (error) {
            console.error('‚ùå Erreur connexion base:', error);
            throw new Error(`Erreur base de donn√©es: ${error.message}`);
          }
          
          console.log(`‚úÖ Connexion base r√©ussie - ${count} licences trouv√©es`);
          return { success: true, count };
        } catch (error) {
          console.error('‚ùå Test connexion √©chou√©:', error);
          throw error;
        }
      }

      // Connexion
      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('loginUser').value.trim().toLowerCase();
        const password = document.getElementById('loginPass').value;
        
        if (username === 'admin' && password === 'admin') {
          currentUser = { login: 'admin', role: 'admin', nom: 'Administrateur' };
          storeSession(currentUser);
          showApp();
          await loadLicences();
          showNotification('Connexion r√©ussie !', 'success');
        } else {
          showNotification('Identifiants incorrects', 'danger');
        }
      });

      function showApp() {
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('currentUser').textContent = `${currentUser.nom} (${currentUser.role})`;
        
        // Afficher le menu admin si l'utilisateur est administrateur
        if (currentUser.role === 'admin') {
          document.getElementById('adminMenu').classList.add('visible');
          console.log('‚úÖ Menu administration activ√© pour:', currentUser.nom);
        }
        
        setupEventListeners();
      }

      function setupEventListeners() {
        // Boutons principaux
        document.getElementById('logoutBtn').addEventListener('click', () => {
          if (confirm('D√©connexion ?')) logout();
        });
        
        document.getElementById('searchInput').addEventListener('input', (e) => {
          filterLicences(e.target.value);
        });
        
        // NOUVELLE LICENCE - FONCTIONNEL
        document.getElementById('addLicenceBtn').addEventListener('click', () => {
          openLicenceModal();
        });
        
        document.getElementById('refreshBtn').addEventListener('click', async () => {
          await loadLicences();
          showNotification('Donn√©es actualis√©es', 'success');
        });

        // Modal events
        document.getElementById('closeModalBtn').addEventListener('click', closeLicenceModal);
        document.getElementById('cancelBtn').addEventListener('click', closeLicenceModal);
        
        // Formulaire de licence
        document.getElementById('licenceForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          await saveLicence();
        });

        // Fermer modal en cliquant en dehors
        document.getElementById('licenceModal').addEventListener('click', (e) => {
          if (e.target.id === 'licenceModal') {
            closeLicenceModal();
          }
        });
      }

      // Fonction pour le bouton Param√®tres (√† venir)
      function showComingSoon() {
        showNotification('Fonctionnalit√© √† venir dans une prochaine version', 'info');
      }

      // CRUD - CREATE & UPDATE
      async function saveLicence() {
        try {
          const formData = new FormData(document.getElementById('licenceForm'));
          const licenceData = {
            software_name: formData.get('software_name'),
            vendor: formData.get('vendor'),
            version: formData.get('version') || null,
            type: formData.get('type'),
            purchase_date: formData.get('purchase_date') || null,
            expiration_date: formData.get('expiration_date') || null,
            initial_cost: parseFloat(formData.get('initial_cost')) || 0,
            seats: parseInt(formData.get('seats')) || 1,
            assigned_to: formData.get('assigned_to') || null
          };

          console.log('üíæ Sauvegarde licence:', licenceData);

          let result;
          if (editingLicenceId) {
            // UPDATE
            licenceData.updated_at = new Date().toISOString();
            result = await supabase
              .from('licences')
              .update(licenceData)
              .eq('id', editingLicenceId);
            
            if (result.error) throw result.error;
            showNotification('Licence mise √† jour avec succ√®s !', 'success');
          } else {
            // CREATE
            licenceData.created_at = new Date().toISOString();
            licenceData.updated_at = new Date().toISOString();
            result = await supabase
              .from('licences')
              .insert([licenceData]);
            
            if (result.error) throw result.error;
            showNotification('Nouvelle licence cr√©√©e avec succ√®s !', 'success');
          }

          closeLicenceModal();
          await loadLicences();

        } catch (error) {
          console.error('‚ùå Erreur sauvegarde:', error);
          showNotification(`Erreur: ${error.message}`, 'danger');
        }
      }

      // CRUD - DELETE
      async function deleteLicence(id) {
        if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette licence ?')) return;
        
        try {
          console.log('üóëÔ∏è Suppression licence ID:', id);
          
          const result = await supabase
            .from('licences')
            .delete()
            .eq('id', id);
          
          if (result.error) throw result.error;
          
          showNotification('Licence supprim√©e avec succ√®s !', 'success');
          await loadLicences();
          
        } catch (error) {
          console.error('‚ùå Erreur suppression:', error);
          showNotification(`Erreur: ${error.message}`, 'danger');
        }
      }

      // Modal Management
      function openLicenceModal(licence = null) {
        editingLicenceId = licence ? licence.id : null;
        
        if (licence) {
          // Mode √©dition
          document.getElementById('modalTitle').textContent = 'Modifier la licence';
          document.getElementById('saveText').textContent = 'Mettre √† jour';
          
          // Remplir le formulaire
          document.getElementById('software_name').value = licence.software_name || '';
          document.getElementById('vendor').value = licence.vendor || '';
          document.getElementById('version').value = licence.version || '';
          document.getElementById('type').value = licence.type || '';
          document.getElementById('purchase_date').value = licence.purchase_date || '';
          document.getElementById('expiration_date').value = licence.expiration_date || '';
          document.getElementById('initial_cost').value = licence.initial_cost || '';
          document.getElementById('seats').value = licence.seats || 1;
          document.getElementById('assigned_to').value = licence.assigned_to || '';
        } else {
          // Mode cr√©ation
          document.getElementById('modalTitle').textContent = 'Nouvelle licence';
          document.getElementById('saveText').textContent = 'Cr√©er';
          document.getElementById('licenceForm').reset();
          document.getElementById('seats').value = 1;
        }
        
        document.getElementById('licenceModal').classList.remove('hidden');
        document.getElementById('software_name').focus();
      }

      function closeLicenceModal() {
        document.getElementById('licenceModal').classList.add('hidden');
        document.getElementById('licenceForm').reset();
        editingLicenceId = null;
      }

      async function loadLicences() {
        try {
          updateStatus('Chargement depuis la base...', false);
          console.log('üîÑ Chargement des licences depuis Supabase...');
          
          const { data, error } = await supabase
            .from('licences')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) {
            console.error('‚ùå Erreur Supabase:', error);
            throw new Error(`Erreur base de donn√©es: ${error.message}`);
          }
          
          licences = data || [];
          updateStatus(`Base de donn√©es connect√©e (${licences.length} licences)`, true);
          
          console.log(`‚úÖ ${licences.length} licences charg√©es depuis la base`);
          
          renderLicences();
          updateLicenceCount();
          checkExpirations();
          
        } catch (error) {
          console.error('‚ùå Erreur chargement:', error);
          updateStatus('Erreur base de donn√©es', false);
          showNotification(`Erreur: ${error.message}`, 'danger');
          
          licences = [];
          renderLicences();
          updateLicenceCount();
        }
      }

      function renderLicences() {
        const tbody = document.getElementById('licenceTableBody');
        tbody.innerHTML = '';
        
        if (licences.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = '<td colspan="9" style="text-align: center; color: #666; padding: 20px;">Aucune licence trouv√©e dans la base de donn√©es</td>';
          tbody.appendChild(row);
          return;
        }
        
        licences.forEach(licence => {
          tbody.appendChild(createLicenceRow(licence));
        });
      }

      function createLicenceRow(licence) {
        const row = document.createElement('tr');
        const today = new Date();
        const expiration = new Date(licence.expiration_date);
        const daysUntilExpiration = Math.ceil((expiration - today) / (1000 * 60 * 60 * 24));
        
        let statusClass = '', statusText = 'Active';
        if (daysUntilExpiration < 0) {
          statusClass = 'status-expired';
          statusText = 'Expir√©e';
        } else if (daysUntilExpiration <= 30) {
          statusClass = 'status-warning';
          statusText = 'Expire bient√¥t';
        }
        
        row.className = statusClass;
        row.innerHTML = `
          <td>#${licence.id}</td>
          <td>${licence.software_name || 'N/A'}</td>
          <td>${licence.vendor || 'N/A'}</td>
          <td>${licence.version || 'N/A'}</td>
          <td><span class="badge">${licence.type || 'N/A'}</span></td>
          <td>${formatDate(licence.expiration_date)}</td>
          <td>${formatPrice(licence.initial_cost)}</td>
          <td>${licence.seats || 0} poste(s)</td>
          <td>
            <button class="btn-view" onclick="viewLicence(${licence.id})">üëÅÔ∏è</button>
            <button class="btn-edit" onclick="editLicence(${licence.id})">‚úèÔ∏è</button>
            <button class="btn-delete" onclick="deleteLicence(${licence.id})">üóëÔ∏è</button>
          </td>
        `;
        return row;
      }

      function checkExpirations() {
        const today = new Date();
        let expiredCount = 0, warningCount = 0;
        
        licences.forEach(licence => {
          const expiration = new Date(licence.expiration_date);
          const daysUntilExpiration = Math.ceil((expiration - today) / (1000 * 60 * 60 * 24));
          
          if (daysUntilExpiration < 0) expiredCount++;
          else if (daysUntilExpiration <= 30) warningCount++;
        });
        
        const alertsContainer = document.getElementById('alertsContainer');
        alertsContainer.innerHTML = '';
        
        if (expiredCount > 0) showAlert(`‚ö†Ô∏è ${expiredCount} licence(s) expir√©e(s)`, 'danger');
        if (warningCount > 0) showAlert(`‚ö° ${warningCount} licence(s) expire(nt) bient√¥t`, 'warning');
      }

      function showAlert(message, type) {
        const alertsContainer = document.getElementById('alertsContainer');
        const alert = document.createElement('div');
        alert.className = `alert ${type}`;
        alert.innerHTML = `<span>${message}</span><button onclick="this.parentElement.remove()">‚úï</button>`;
        alertsContainer.appendChild(alert);
      }

      function formatDate(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleDateString('fr-FR');
      }

      function formatPrice(price) {
        if (!price && price !== 0) return 'N/A';
        return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(price);
      }

      function updateStatus(text, online) {
        document.getElementById('statusText').textContent = text;
        document.getElementById('statusIndicator').className = `status-indicator ${online ? 'online' : 'offline'}`;
      }

      function updateLicenceCount() {
        document.getElementById('licenceCount').textContent = `${licences.length} licence(s)`;
      }

      function filterLicences(searchTerm) {
        const rows = document.querySelectorAll('#licenceTableBody tr');
        const term = searchTerm.toLowerCase();
        rows.forEach(row => {
          row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
        });
      }

      function viewLicence(id) {
        const licence = licences.find(l => l.id === id);
        if (licence) {
          alert(`Licence: ${licence.software_name} ${licence.version}\\nFournisseur: ${licence.vendor}\\nType: ${licence.type}\\nExpiration: ${formatDate(licence.expiration_date)}\\nPrix: ${formatPrice(licence.initial_cost)}\\nPostes: ${licence.seats}\\nAssign√© √†: ${licence.assigned_to || 'Non assign√©'}`);
        }
      }

      // √âDITION - FONCTIONNELLE
      function editLicence(id) {
        const licence = licences.find(l => l.id === id);
        if (licence) {
          openLicenceModal(licence);
        }
      }

      function sortTable(column) {
        const direction = sortDirection[column] === 'asc' ? 'desc' : 'asc';
        sortDirection[column] = direction;
        
        licences.sort((a, b) => {
          let aVal = a[column] || '', bVal = b[column] || '';
          if (column === 'initial_cost' || column === 'seats') { 
            aVal = parseFloat(aVal) || 0; 
            bVal = parseFloat(bVal) || 0; 
          } else if (column === 'expiration_date') { 
            aVal = new Date(aVal); 
            bVal = new Date(bVal); 
          } else { 
            aVal = aVal.toString().toLowerCase(); 
            bVal = bVal.toString().toLowerCase(); 
          }
          return direction === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
        });
        renderLicences();
      }

      function storeSession(userInfo) {
        try {
          document.cookie = `session_user=${btoa(JSON.stringify(userInfo))}; max-age=86400; path=/`;
        } catch (error) { console.warn('Session storage failed'); }
      }

      function getStoredSession() {
        try {
          const cookies = document.cookie.split(';');
          const sessionCookie = cookies.find(c => c.trim().startsWith('session_user='));
          if (sessionCookie) {
            return JSON.parse(atob(sessionCookie.split('=')[1]));
          }
        } catch (error) { console.warn('Session invalid'); }
        return null;
      }

      function logout() {
        document.cookie = 'session_user=; max-age=0; path=/';
        currentUser = null;
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('adminMenu').classList.remove('visible');
        document.getElementById('loginForm').reset();
        showNotification('D√©connexion r√©ussie', 'info');
      }

      function showNotification(message, type = 'info') {
        const container = document.getElementById('notificationsContainer') || createNotificationsContainer();
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `<div class="toast-content"><span>${message}</span><button class="toast-close" onclick="this.parentElement.parentElement.remove()">‚úï</button></div>`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => { toast.classList.add('removing'); setTimeout(() => toast.remove(), 300); }, 5000);
      }

      function createNotificationsContainer() {
        const container = document.createElement('div');
        container.id = 'notificationsContainer';
        container.className = 'notifications-container';
        document.body.appendChild(container);
        return container;
      }
    </script>
  </body>
</html>